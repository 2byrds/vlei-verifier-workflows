version: '3.8'

configs:
  wan.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wan": {
            "dt": "2022-01-20T12:57:59.823350+00:00",
            "curls": ["tcp://localhost:5632/", "http://localhost:5642/"]
          }
      }
  wil.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wil": {
              "dt": "2022-01-20T12:57:59.823350+00:00",
              "curls": ["http://localhost:5643/"]
          }
      }
  wes.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wes": {
              "dt": "2022-01-20T12:57:59.823350+00:00",
              "curls": ["http://localhost:5644/"]
          }
      }
  wit.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wit": {
              "dt": "2022-01-20T12:57:59.823350+00:00",
              "curls": ["http://localhost:5645/"]
          }
      }
  wub.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wub": {
              "dt": "2022-01-20T12:57:59.823350+00:00",
              "curls": ["http://localhost:5646/"]
          }
      }
  wyx.json:
    content: |
      {
          "dt": "2022-01-20T12:57:59.823350+00:00",
          "wyx": {
              "dt": "2022-01-20T12:57:59.823350+00:00",
              "curls": ["http://localhost:5647/"]
          }
      }

services:
  vlei-server:
    image: gleif/vlei
    network_mode: host
    # container_name: vlei-server
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=UTF-8
    command:
      - vLEI-server
      - -s
      - ./schema/acdc
      - -c
      - ./samples/acdc/
      - -o
      - ./samples/oobis/
    healthcheck:
      test:
        - CMD
        - curl
        - -f
        - http://localhost:7723/oobi/EBfdlu8R27Fbx-ehrqwImnK-8Cm79sqbAQ4MmvEAYqao
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    ports:
      - 7723:7723
    extra_hosts:
      - 'localhost:127.0.0.1'

  witness-demo:
    image: weboftrust/keri-witness-demo:1.1.0
    network_mode: host
    # container_name: witness-demo
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=UTF-8
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5642/oobi']
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    configs:
      - source: wan.json
        target: /keripy/scripts/keri/cf/main/wan.json
      - source: wes.json
        target: /keripy/scripts/keri/cf/main/wes.json
      - source: wil.json
        target: /keripy/scripts/keri/cf/main/wil.json
      - source: wit.json
        target: /keripy/scripts/keri/cf/main/wit.json
      - source: wub.json
        target: /keripy/scripts/keri/cf/main/wub.json
      - source: wyx.json
        target: /keripy/scripts/keri/cf/main/wyx.json
    ports:
      - 5642:5642
      - 5643:5643
      - 5644:5644
      - 5645:5645
      - 5646:5646
      - 5647:5647
    extra_hosts:
      - 'localhost:127.0.0.1'

  vlei-verifier:
    image: gleif/vlei-verifier:latest
    network_mode: host
    # container_name: vlei-verifier
    environment:
      - VERIFIER_CONFIG_FILE=verifier-config-test.json
    depends_on:
      - vlei-server
      - witness-demo
    ports:
      - 7676:7676
    healthcheck:
      test: ['CMD', 'wget', '--spider', 'http://localhost:7676/health']
      interval: 2s
      timeout: 3s
      retries: 5
      start_period: 2s
    extra_hosts:
      - 'localhost:127.0.0.1'

  deps:
    image: alpine
    network_mode: host
    command: ['echo', 'Dependencies running']
    depends_on:
      vlei-server:
        condition: service_healthy
      witness-demo:
        condition: service_healthy
    extra_hosts:
      - 'localhost:127.0.0.1'

  verify:
    image: alpine
    network_mode: host
    command: ['echo', 'Dependencies running']
    depends_on:
      vlei-server:
        condition: service_healthy
      witness-demo:
        condition: service_healthy
      vlei-verifier:
        condition: service_healthy
    extra_hosts:
      - 'localhost:127.0.0.1'
